import { APIEvaluation } from '../types/evaluation'

export function generateMarkdownReport(evaluation: APIEvaluation): string {
  const timestamp = new Date().toLocaleString('zh-TW')
  
  // Generate score badge
  const getScoreBadge = (score: number): string => {
    if (score >= 80) return 'ğŸŸ¢ å„ªç§€'
    if (score >= 60) return 'ğŸŸ¡ è‰¯å¥½'
    return 'ğŸ”´ éœ€æ”¹é€²'
  }

  // Category translations
  const categoryNames: Record<string, string> = {
    resource_design: 'è³‡æºè¨­è¨ˆ',
    http_methods: 'HTTP æ–¹æ³•',
    status_codes: 'ç‹€æ…‹ç¢¼',
    naming_conventions: 'å‘½åè¦ç¯„',
    request_response: 'è«‹æ±‚/å›æ‡‰',
    versioning: 'ç‰ˆæœ¬æ§åˆ¶',
    documentation: 'æ–‡ä»¶å®Œæ•´æ€§',
  }

  const categoryIcons: Record<string, string> = {
    resource_design: 'ğŸ—ï¸',
    http_methods: 'ğŸ”§',
    status_codes: 'ğŸ“Š',
    naming_conventions: 'ğŸ“',
    request_response: 'ğŸ”„',
    versioning: 'ğŸ“‹',
    documentation: 'ğŸ“š',
  }

  let markdown = ''

  // Header
  markdown += '# API Judge è©•ä¼°å ±å‘Š\n\n'
  markdown += `> ğŸ• è©•ä¼°æ™‚é–“: ${timestamp}\n`
  markdown += `> âš–ï¸ Powered by Gemini AI\n\n`
  markdown += '---\n\n'

  // Overall Score Section
  markdown += '## ğŸ“Š ç¸½é«”è©•åˆ†\n\n'
  markdown += `### **${evaluation.overall_score}/100** ${getScoreBadge(evaluation.overall_score)}\n\n`
  
  // Progress bar visualization
  const progressBar = 'â–ˆ'.repeat(Math.floor(evaluation.overall_score / 10)) + 
                     'â–‘'.repeat(10 - Math.floor(evaluation.overall_score / 10))
  markdown += `\`[${progressBar}]\` ${evaluation.overall_score}%\n\n`

  // Summary
  markdown += '## ğŸ“‹ è©•ä¼°æ‘˜è¦\n\n'
  markdown += `${evaluation.summary}\n\n`

  // Critical Issues
  if (evaluation.critical_issues.length > 0) {
    markdown += '## ğŸš¨ é—œéµå•é¡Œ\n\n'
    markdown += 'ä»¥ä¸‹æ˜¯éœ€è¦ç«‹å³è™•ç†çš„é—œéµå•é¡Œï¼š\n\n'
    evaluation.critical_issues.forEach(issue => {
      markdown += `- âŒ ${issue}\n`
    })
    markdown += '\n'
  }

  // Best Practices
  if (evaluation.best_practices_followed.length > 0) {
    markdown += '## âœ… éµå¾ªçš„æœ€ä½³å¯¦è¸\n\n'
    markdown += 'æ‚¨çš„ API è¨­è¨ˆåœ¨ä»¥ä¸‹æ–¹é¢è¡¨ç¾è‰¯å¥½ï¼š\n\n'
    evaluation.best_practices_followed.forEach(practice => {
      markdown += `- âœ”ï¸ ${practice}\n`
    })
    markdown += '\n'
  }

  // Category Details
  markdown += '## ğŸ“ˆ åˆ†é¡è©•åˆ†è©³ç´°\n\n'
  
  Object.entries(evaluation.categories).forEach(([key, category]) => {
    const icon = categoryIcons[key] || 'ğŸ“Œ'
    const name = categoryNames[key] || key
    const badge = getScoreBadge(category.score)
    
    markdown += `### ${icon} ${name}\n\n`
    markdown += `**è©•åˆ†: ${category.score}/100** ${badge}\n\n`
    
    // Progress bar for category
    const catProgressBar = 'â–“'.repeat(Math.floor(category.score / 10)) + 
                          'â–‘'.repeat(10 - Math.floor(category.score / 10))
    markdown += `\`[${catProgressBar}]\`\n\n`
    
    // Issues
    if (category.issues.length > 0) {
      markdown += '**ç™¼ç¾çš„å•é¡Œ:**\n\n'
      category.issues.forEach(issue => {
        markdown += `- âš ï¸ ${issue}\n`
      })
      markdown += '\n'
    }
    
    // Suggestions
    if (category.suggestions.length > 0) {
      markdown += '**æ”¹é€²å»ºè­°:**\n\n'
      category.suggestions.forEach(suggestion => {
        markdown += `- ğŸ’¡ ${suggestion}\n`
      })
      markdown += '\n'
    }
    
    markdown += '---\n\n'
  })

  // Score Summary Table
  markdown += '## ğŸ“Š è©•åˆ†ç¸½è¦½è¡¨\n\n'
  markdown += '| é¡åˆ¥ | è©•åˆ† | ç‹€æ…‹ |\n'
  markdown += '|------|------|------|\n'
  
  Object.entries(evaluation.categories).forEach(([key, category]) => {
    const icon = categoryIcons[key] || 'ğŸ“Œ'
    const name = categoryNames[key] || key
    const badge = getScoreBadge(category.score)
    markdown += `| ${icon} ${name} | ${category.score}/100 | ${badge} |\n`
  })
  
  markdown += `| **ç¸½é«”è©•åˆ†** | **${evaluation.overall_score}/100** | **${getScoreBadge(evaluation.overall_score)}** |\n\n`

  // Footer
  markdown += '---\n\n'
  markdown += '*Generated by [API Judge](https://api-judge.vercel.app) - RESTful API Design Checker*\n'
  markdown += '*Powered by Google Gemini AI*\n'
  markdown += '*Advantech WiseIoT Internal Tool*\n'

  return markdown
}

export function downloadMarkdownReport(evaluation: APIEvaluation, filename?: string): void {
  const markdown = generateMarkdownReport(evaluation)
  const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' })
  const url = URL.createObjectURL(blob)
  
  const timestamp = new Date().toISOString().split('T')[0]
  const defaultFilename = `api-judge-report-${timestamp}.md`
  
  const link = document.createElement('a')
  link.href = url
  link.download = filename || defaultFilename
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  
  URL.revokeObjectURL(url)
}